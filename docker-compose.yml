services:
  go2rtc:
    image: alexxit/go2rtc:latest
    container_name: go2rtc
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./go2rtc.yml:/config/go2rtc.yaml:ro

  web:
    image: nginx:alpine
    container_name: camdash_web
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "8080:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - CAMDASH_HOST=${CAMDASH_HOST:-}
      - CAMDASH_GO2RTC_BASE=${CAMDASH_GO2RTC_BASE:-}
    command: /bin/sh -c 'if [ -n "$CAMDASH_HOST" ] && [ -z "$CAMDASH_GO2RTC_BASE" ]; then export CAMDASH_GO2RTC_BASE="http://$CAMDASH_HOST:1984"; fi; if command -v envsubst >/dev/null 2>&1; then envsubst < /usr/share/nginx/html/config.runtime.template.js > /usr/share/nginx/html/config.runtime.js; else printf "%s\n" "(() => {" "  const override = {};" "  const go2rtcBase = \"$CAMDASH_GO2RTC_BASE\";" "  if (go2rtcBase) override.go2rtcBase = go2rtcBase;" "  window.CAMDASH_CONFIG = { ...(window.CAMDASH_CONFIG || {}), ...override };" "})();" > /usr/share/nginx/html/config.runtime.js; fi; exec nginx -g "daemon off;"'
    volumes:
      - ./dashboard:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

  api:
    build: ./api
    container_name: camdash_api
    restart: unless-stopped
    environment:
      - CAMDASH_DB=/data/camdash.db
      - CAMDASH_PORT=3000
      - CAMDASH_MAX_CAMS=6
      - CAMDASH_ADMIN_USER=${CAMDASH_ADMIN_USER:-admin}
      - CAMDASH_ADMIN_PASS=${CAMDASH_ADMIN_PASS:-changeme}
    volumes:
      - ./data:/data
